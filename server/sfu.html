<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<title>sfu</title>

	<style type="text/css">
		.comments {
			width: 100%; /*auto width*/
			overflow: auto;
			word-break: break-all;
		}
	</style>
</head>

<body>
<video id="video1" width="320" height="240" autoplay muted controls hidden></video>
<br/>
<video id="video" width="320" height="240" autoplay controls></video>
<br/>
<br/>
<br/>
<audio id="audio" width="320" height="240" autoplay controls></audio>
<br/>

<button class="sessbtn" onclick="createSession()">Publish</button>

<div id="signalingContainer" style="display: none">
	Client SDP<textarea class="comments" id="localSDP" readonly="true" rows=10 cols=30 onpropertychange="this.style.posHeight=this.scrollHeight "></textarea>
	Server SDP<textarea class="comments" id="remoteSDP" readonly="true" rows=10 cols=30 onpropertychange="this.style.posHeight=this.scrollHeight "></textarea>
</div>

<div id="logs"></div>
<script>
  var log = msg => {
    document.getElementById('logs').innerHTML += msg + '<br>'
  }

  var sock = null;
  var wsuri = "ws://" + location.host + "/ws";

  window.onload = function () {
    sock = new WebSocket(wsuri);
    sock.onopen = function () {
      console.log("websocket connected to " + wsuri);
    }

    sock.onclose = function (e) {
      console.log("websocket connection closed (" + e.code + ")");
    }

    sock.onmessage = function (e) {
      var data = JSON.parse(e.data)
      document.getElementById('remoteSDP').value = data.join_room_rsp.session_description.sdp
      window.startSession();
    }

    sock.onerror = function (e) {
    }
  };

  function createSession() {
    let pc = new RTCPeerConnection({
      iceServers: [
        {
          urls: 'stun:222.73.105.251:3478'
        }
      ]
    });

    pc.oniceconnectionstatechange = function (e) {
      log(pc.iceConnectionState)
    }

    pc.onicecandidate = function (event) {
      if (event.candidate === null) {
        var join = {
          type: 1,
          join_room_req: {
            user_id: "pg61l7vj76q1",
            // type:"pub",
            type: "sub",
            room_id: "xsnxdxvgnyn",
            // user_id: Math.random().toString(36).substring(2),
            session_description: pc.localDescription,
          },
        };
        document.getElementById('localSDP').value = pc.localDescription.sdp;
        sock.send(JSON.stringify(join));
        console.log("onicecandidate");
      }
    }

    pc.ontrack = function (e) {
      if (e && e.streams) {
        console.log('收到对方音频/视频流数据...');
        var stream = e.streams[0]
        var el = document.getElementById("video");
        el.srcObject = stream;

        console.log(stream)
      }
    }

    var dc = pc.createDataChannel("dc")
    dc.onmessage = function (event) {
      console.log(event.data);
    }
    dc.onopen = function (event) {
      dc.send("来自客户端的消息");
    }

    navigator.mediaDevices.getUserMedia({video: true, audio: true})
      .then(stream => {
        document.getElementById('video1').srcObject = stream
        stream.getTracks().forEach(track => {
          pc.addTrack(track, stream);
        });

        pc.createOffer()
          .then(d => {
            pc.setLocalDescription(d);
            console.log(d.sdp);
          })
          .catch(log);
      }).catch(log);


    window.startSession = function () {
      let sd = document.getElementById('remoteSDP').value;
      if (sd === '') {
        return alert('Session Description must not be empty');
      }

      try {
        pc.setRemoteDescription(new RTCSessionDescription({type: 'answer', sdp: sd}));
      } catch (e) {
        alert(e);
      }
    }

    let btns = document.getElementsByClassName('sessbtn');
    for (let i = 0; i < btns.length; i++) {
      btns[i].style = 'display: none';
    }

    document.getElementById('signalingContainer').style = 'display: block';
  }

</script>

</body>

</html>
